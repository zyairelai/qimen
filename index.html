<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>é£åå¥‡é—¨ - å†œå†ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
  <script src="constants.js"></script>
</head>
<body>

<div class="top-bar">
  <div class="controls">
    <button id="prevBtn">â—€</button>
    <div class="datetime-display" id="dateShow">Loading...</div>
    <button id="nextBtn">â–¶</button>
    <button id="nowBtn">ğŸ•’</button>
    <button id="copyBtn">ğŸ“‹</button>
  </div>
  <div class="lunar-info" id="lunarShow">è·å–å†œå†ä¸­...</div>
</div>

<div class="picker-overlay" id="overlay">
  <div class="custom-picker">
    <div class="picker-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; font-weight:bold;">
      <span style="padding:10px; cursor:pointer" id="prevMonth">â—€</span>
      <span id="monthYearTitle"></span>
      <span style="padding:10px; cursor:pointer" id="nextMonth">â–¶</span>
    </div>
    <div class="picker-grid" id="daysGrid"></div>
    <div class="time-setter">
      <input type="time" id="timeInput" style="font-size:18px; padding:5px; border-radius:6px; border:1px solid #ddd;">
      <button id="confirmTimeBtn" style="padding:8px 20px; background:var(--primary-color); color:white; border:none; border-radius:8px; font-weight:bold;">ç¡®å®š</button>
    </div>
  </div>
</div>

<div class="grid-container" id="qimenGrid">
  <div class="grid-item"><div class="main-content"></div> <span class="position">å·½å››å®®</span></div>
  <div class="grid-item"><div class="main-content"></div> <span class="position">ç¦»ä¹å®®</span></div>
  <div class="grid-item"><div class="main-content"></div> <span class="position">å¤äºŒå®®</span></div>
  <div class="grid-item"><div class="main-content"></div> <span class="position">éœ‡ä¸‰å®®</span></div>
  <div class="grid-item"><div class="main-content"></div> <span class="position">ä¸­äº”å®®</span></div>
  <div class="grid-item"><div class="main-content"></div> <span class="position">å…‘ä¸ƒå®®</span></div>
  <div class="grid-item"><div class="main-content"></div> <span class="position">è‰®å…«å®®</span></div>
  <div class="grid-item"><div class="main-content"></div> <span class="position">åä¸€å®®</span></div>
  <div class="grid-item"><div class="main-content"></div> <span class="position">ä¹¾å…­å®®</span></div>
</div>

<script>
  // --- çŠ¶æ€ç®¡ç† ---
  let currentViewDate = getGmt8Date();
  let selectedDate = getGmt8Date();

  // --- å…ƒç´ å¼•ç”¨ ---
  const dateShow = document.getElementById('dateShow');
  const lunarShow = document.getElementById('lunarShow');
  const overlay = document.getElementById('overlay');
  const daysGrid = document.getElementById('daysGrid');
  const timeInput = document.getElementById('timeInput');
  const monthYearTitle = document.getElementById('monthYearTitle');

  // --- æ ¸å¿ƒé€»è¾‘ ---
  function getGmt8Date() {
    const now = new Date();
    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    return new Date(utc + (3600000 * 8));
  }

  function renderUI() {
    const y = selectedDate.getFullYear();
    const m = String(selectedDate.getMonth() + 1).padStart(2, '0');
    const d = String(selectedDate.getDate()).padStart(2, '0');
    const h = String(selectedDate.getHours()).padStart(2, '0');
    const min = String(selectedDate.getMinutes()).padStart(2, '0');

    dateShow.textContent = `${y}-${m}-${d} ${h}:${min}`;
    timeInput.value = `${h}:${min}`;

    // è·å–å†œå†
    const lunar = Lunar.fromDate(selectedDate);
    
    // å¤„ç†å­æ—¶æ¢æ—¥é€»è¾‘
    let dayLunar = lunar;
    if (selectedDate.getHours() === 23) {
      const nextDay = new Date(selectedDate.getTime() + 3600000);
      dayLunar = Lunar.fromDate(nextDay);
    }

    const gzYear = lunar.getYearInGanZhi();
    const gzMonth = lunar.getMonthInGanZhi();
    const gzDay = dayLunar.getDayInGanZhi(); 
    const gzTime = lunar.getTimeInGanZhi();
    const lunarMonth = lunar.getMonthInChinese();
    const lunarDay = lunar.getDayInChinese();

    lunarShow.textContent = `å†œå†ï¼š${lunarMonth}${lunarDay}\n${gzYear}å¹´ ${gzMonth}æœˆ ${gzDay}æ—¥ ${gzTime}æ—¶`;

    renderCalendar();
  }

  function renderCalendar() {
    daysGrid.innerHTML = '';
    const year = currentViewDate.getFullYear();
    const month = currentViewDate.getMonth();
    monthYearTitle.textContent = `${CONSTANTS.MONTH_NAMES[month]} ${year}`;
    
    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();
    
    for (let i = 0; i < firstDay; i++) { 
        daysGrid.appendChild(document.createElement('div')); 
    }
    
    for (let day = 1; day <= lastDate; day++) {
      const dayEl = document.createElement('div');
      const isSelected = day === selectedDate.getDate() && 
                         month === selectedDate.getMonth() && 
                         year === selectedDate.getFullYear();
      
      dayEl.className = 'picker-day' + (isSelected ? ' selected' : '');
      dayEl.textContent = day;
      dayEl.onclick = (e) => {
        e.stopPropagation();
        selectedDate.setFullYear(year);
        selectedDate.setMonth(month);
        selectedDate.setDate(day);
        renderUI();
      };
      daysGrid.appendChild(dayEl);
    }
  }

  function changeMonth(step) {
    currentViewDate.setMonth(currentViewDate.getMonth() + step);
    renderCalendar();
  }

  // --- äº¤äº’äº‹ä»¶ ---
  dateShow.onclick = () => {
    overlay.classList.add('active');
    document.body.style.overflow = 'hidden';
  };

  overlay.onclick = (e) => {
    if (e.target === overlay) {
      overlay.classList.remove('active');
      document.body.style.overflow = '';
    }
  };

  document.getElementById('prevMonth').onclick = () => changeMonth(-1);
  document.getElementById('nextMonth').onclick = () => changeMonth(1);

  document.getElementById('confirmTimeBtn').onclick = () => {
    const [h, m] = timeInput.value.split(':');
    selectedDate.setHours(parseInt(h));
    selectedDate.setMinutes(parseInt(m));
    currentViewDate = new Date(selectedDate);
    renderUI();
    overlay.classList.remove('active');
    document.body.style.overflow = '';
  };

  document.getElementById('prevBtn').onclick = () => {
    selectedDate.setHours(selectedDate.getHours() - 2);
    currentViewDate = new Date(selectedDate);
    renderUI();
  };

  document.getElementById('nextBtn').onclick = () => {
    selectedDate.setHours(selectedDate.getHours() + 2);
    currentViewDate = new Date(selectedDate);
    renderUI();
  };

  document.getElementById('nowBtn').onclick = () => {
    selectedDate = getGmt8Date();
    currentViewDate = new Date(selectedDate);
    renderUI();
  };

  document.getElementById('copyBtn').onclick = function() {
    const fullText = `${dateShow.textContent} (${lunarShow.textContent.replace('\n', ' ')})`;
    navigator.clipboard.writeText(fullText);
    const originalText = this.textContent;
    this.textContent = 'âœ…';
    setTimeout(() => { this.textContent = originalText; }, 800);
  };

  // åˆå§‹åŒ–å¯åŠ¨
  renderUI();
</script>

</body>
</html>
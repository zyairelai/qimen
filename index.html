<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>é£åå¥‡é—¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
</head>
<body>

<div class="top-bar">
  <div class="controls">
    <button id="prevBtn">â—€</button>
    <div class="datetime-display" id="dateShow">Loading...</div>
    <button id="nextBtn">â–¶</button>
    <button id="nowBtn">ğŸ•’</button>
    <button id="copyBtn">ğŸ“‹</button>
  </div>
  <div class="lunar-info" id="lunarShow">LOADING...</div>
</div>

<div class="picker-overlay" id="overlay">
  <div class="custom-picker">
    <div class="picker-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; font-weight:bold;">
      <span style="padding:10px; cursor:pointer" id="prevMonth">â—€</span>
      <div id="monthYearTitle" style="display:flex; gap:10px; cursor:pointer;">
        <span id="selectMonthText"></span> 
        <span id="selectYearText"></span>
      </div>
      <span style="padding:10px; cursor:pointer" id="nextMonth">â–¶</span>
    </div>
    <div class="picker-grid" id="daysGrid"></div>
    <div class="time-setter">
      <input type="time" id="timeInput" style="font-size:18px; padding:5px; border-radius:6px; border:1px solid #ddd;">
      <button id="confirmTimeBtn" style="padding:8px 20px; background:var(--primary-color); color:white; border:none; border-radius:8px; font-weight:bold;">OK</button>
    </div>
  </div>
</div>

<div class="grid-container" id="qimenGrid">
  <div class="grid-item"><div class="main-content"></div> <span class="position">å››</span></div>
  <div class="grid-item"><div class="main-content"></div> <span class="position">ä¹</span></div>
  <div class="grid-item"><div class="main-content"></div> <span class="position">äºŒ</span></div>
  <div class="grid-item"><div class="main-content"></div> <span class="position">ä¸‰</span></div>
  <div class="grid-item"><div class="main-content"></div> <span class="position">äº”</span></div>
  <div class="grid-item"><div class="main-content"></div> <span class="position">ä¸ƒ</span></div>
  <div class="grid-item"><div class="main-content"></div> <span class="position">å…«</span></div>
  <div class="grid-item"><div class="main-content"></div> <span class="position">ä¸€</span></div>
  <div class="grid-item"><div class="main-content"></div> <span class="position">å…­</span></div>
</div>

<script>
  // --- å…¨å±€çŠ¶æ€ç®¡ç† (ä¾›å¤–éƒ¨ JS ä½¿ç”¨) ---
  let currentViewDate = getGmt8Date();
  let selectedDate = getGmt8Date();

  // --- æ ¸å¿ƒé€»è¾‘ ---
  function getGmt8Date() {
    const now = new Date();
    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    return new Date(utc + (3600000 * 8));
  }

  function renderUI() {
    const dateShow = document.getElementById('dateShow');
    const lunarShow = document.getElementById('lunarShow');
    const timeInput = document.getElementById('timeInput');

    const y = selectedDate.getFullYear();
    const m = String(selectedDate.getMonth() + 1).padStart(2, '0');
    const d = String(selectedDate.getDate()).padStart(2, '0');
    const h = String(selectedDate.getHours()).padStart(2, '0');
    const min = String(selectedDate.getMinutes()).padStart(2, '0');

    dateShow.textContent = `${y}-${m}-${d} ${h}:${min}`;
    timeInput.value = `${h}:${min}`;

    // è·å–å†œå†
    const lunar = Lunar.fromDate(selectedDate);
    let dayLunar = lunar;
    if (selectedDate.getHours() === 23) {
      const nextDay = new Date(selectedDate.getTime() + 3600000);
      dayLunar = Lunar.fromDate(nextDay);
    }

    const gzYear = lunar.getYearInGanZhi();
    const gzMonth = lunar.getMonthInGanZhi();
    const gzDay = dayLunar.getDayInGanZhi(); 
    const gzTime = lunar.getTimeInGanZhi();
    const lunarMonth = lunar.getMonthInChinese();
    const lunarDay = lunar.getDayInChinese();

    lunarShow.textContent = `å†œå†ï¼š${lunarMonth}æœˆ${lunarDay}\n${gzYear}å¹´ ${gzMonth}æœˆ ${gzDay}æ—¥ ${gzTime}æ—¶`;

    // è§¦å‘å¤–éƒ¨ calendar.js çš„æ›´æ–°
    if (typeof renderCalendar === 'function') {
        renderCalendar();
    }
    
    // é¢„ç•™ç»™ qimen.js çš„å…¥å£
    // if (typeof updateQimen === 'function') updateQimen();
  }

  // --- åŸºç¡€äº¤äº’äº‹ä»¶ ---
  document.getElementById('dateShow').onclick = () => {
    document.getElementById('overlay').classList.add('active');
    document.body.style.overflow = 'hidden';
  };

  document.getElementById('overlay').onclick = (e) => {
    if (e.target.id === 'overlay') {
      e.target.classList.remove('active');
      document.body.style.overflow = '';
    }
  };

  document.getElementById('confirmTimeBtn').onclick = () => {
    const timeVal = document.getElementById('timeInput').value;
    const [h, m] = timeVal.split(':');
    selectedDate.setHours(parseInt(h));
    selectedDate.setMinutes(parseInt(m));
    currentViewDate = new Date(selectedDate);
    renderUI();
    document.getElementById('overlay').classList.remove('active');
    document.body.style.overflow = '';
  };

  document.getElementById('prevBtn').onclick = () => {
    selectedDate.setHours(selectedDate.getHours() - 2);
    currentViewDate = new Date(selectedDate);
    renderUI();
  };

  document.getElementById('nextBtn').onclick = () => {
    selectedDate.setHours(selectedDate.getHours() + 2);
    currentViewDate = new Date(selectedDate);
    renderUI();
  };

  document.getElementById('nowBtn').onclick = () => {
    selectedDate = getGmt8Date();
    currentViewDate = new Date(selectedDate);
    renderUI();
  };

  // åˆå§‹åŒ–å¯åŠ¨
  renderUI();
</script>

<script src="calendar.js"></script>
<script src="clipboard.js"></script>

</body>
</html>